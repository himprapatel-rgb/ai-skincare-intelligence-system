"""\nConsent and Privacy Policy Management Router\n\nSRS Traceability:\n- BR12: Policies (Terms of Service, Privacy Policy) must be accepted before registration\n- FR46: Tag analyses with model version and provide human-readable explanation factors\n- NFR4: Use AES-256 encryption for sensitive data at rest and TLS in transit\n- NFR6: Data stored regionally where required (GDPR and equivalent compliance)\n\nSprint: 1.2 - Story 1.9\n"""\n\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom sqlalchemy.orm import Session\nfrom datetime import datetime\nfrom typing import Optional\nimport logging\n\nfrom app.models.user import User, UserConsent, PolicyVersion\nfrom app.schemas.consent import ConsentCreate, ConsentResponse, PolicyResponse\nfrom app.core.security import get_current_user\nfrom app.db.session import get_db\n\nrouter = APIRouter(prefix="/consent", tags=["consent"])\nlogger = logging.getLogger(__name__)\n\n\n@router.get("/policies/current", response_model=PolicyResponse)\nasync def get_current_policies(db: Session = Depends(get_db)):\n    """\n    Get current active policy versions (Terms & Privacy Policy).\n    \n    SRS: BR12, NFR6\n    Sprint: 1.2 - Story 1.9\n    """\n    terms = db.query(PolicyVersion).filter(\n        PolicyVersion.policy_type == "terms_of_service",\n        PolicyVersion.is_active == True\n    ).first()\n    \n    privacy = db.query(PolicyVersion).filter(\n        PolicyVersion.policy_type == "privacy_policy",\n        PolicyVersion.is_active == True\n    ).first()\n    \n    if not terms or not privacy:\n        raise HTTPException(\n            status_code=500,\n            detail="Active policies not found"\n        )\n    \n    return PolicyResponse(\n        terms_of_service={\n            "version": terms.version,\n            "effective_date": terms.effective_date.isoformat(),\n            "content_url": terms.content_url or "/terms",\n            "summary": terms.summary\n        },\n        privacy_policy={\n            "version": privacy.version,\n            "effective_date": privacy.effective_date.isoformat(),\n            "content_url": privacy.content_url or "/privacy",\n            "summary": privacy.summary\n        }\n    )\n\n\n@router.post("/accept", response_model=ConsentResponse)\nasync def accept_policies(\n    consent_data: ConsentCreate,\n    current_user: User = Depends(get_current_user),\n    db: Session = Depends(get_db)\n):\n    """\n    Accept Terms of Service and Privacy Policy.\n    \n    SRS: BR12 - Policies must be accepted before registration\n    Sprint: 1.2 - Story 1.9\n    """\n    # Get current policy versions\n    terms = db.query(PolicyVersion).filter(\n        PolicyVersion.policy_type == "terms_of_service",\n        PolicyVersion.version == consent_data.terms_version\n    ).first()\n    \n    privacy = db.query(PolicyVersion).filter(\n        PolicyVersion.policy_type == "privacy_policy",\n        PolicyVersion.version == consent_data.privacy_version\n    ).first()\n    \n    if not terms or not privacy:\n        raise HTTPException(\n            status_code=400,\n            detail="Invalid policy versions"\n        )\n    \n    # Check if consent already exists\n    existing_consent = db.query(UserConsent).filter(\n        UserConsent.user_id == current_user.id\n    ).first()\n    \n    if existing_consent:\n        # Update existing consent\n        existing_consent.terms_accepted = consent_data.terms_accepted\n        existing_consent.privacy_accepted = consent_data.privacy_accepted\n        existing_consent.terms_version = consent_data.terms_version\n        existing_consent.privacy_version = consent_data.privacy_version\n        existing_consent.accepted_at = datetime.utcnow()\n        existing_consent.ip_address = consent_data.ip_address\n        \n        db.commit()\n        db.refresh(existing_consent)\n        \n        user_consent = existing_consent\n    else:\n        # Create new consent record\n        user_consent = UserConsent(\n            user_id=current_user.id,\n            terms_accepted=consent_data.terms_accepted,\n            privacy_accepted=consent_data.privacy_accepted,\n            terms_version=consent_data.terms_version,\n            privacy_version=consent_data.privacy_version,\n            accepted_at=datetime.utcnow(),\n            ip_address=consent_data.ip_address\n        )\n        \n        db.add(user_consent)\n        db.commit()\n        db.refresh(user_consent)\n    \n    logger.info(\n        f"Consent accepted for user {current_user.id}",\n        extra={\n            "user_id": str(current_user.id),\n            "terms_version": consent_data.terms_version,\n            "privacy_version": consent_data.privacy_version,\n            "timestamp": datetime.utcnow().isoformat()\n        }\n    )\n    \n    return ConsentResponse(\n        id=user_consent.id,\n        user_id=user_consent.user_id,\n        terms_accepted=user_consent.terms_accepted,\n        privacy_accepted=user_consent.privacy_accepted,\n        terms_version=user_consent.terms_version,\n        privacy_version=user_consent.privacy_version,\n        accepted_at=user_consent.accepted_at\n    )\n\n\n@router.get("/status", response_model=ConsentResponse)\nasync def get_consent_status(\n    current_user: User = Depends(get_current_user),\n    db: Session = Depends(get_db)\n):\n    """\n    Get user's consent status.\n    \n    SRS: BR12, NFR6\n    Sprint: 1.2 - Story 1.9\n    """\n    consent = db.query(UserConsent).filter(\n        UserConsent.user_id == current_user.id\n    ).first()\n    \n    if not consent:\n        raise HTTPException(\n            status_code=404,\n            detail="Consent record not found"\n        )\n    \n    return ConsentResponse(\n        id=consent.id,\n        user_id=consent.user_id,\n        terms_accepted=consent.terms_accepted,\n        privacy_accepted=consent.privacy_accepted,\n        terms_version=consent.terms_version,\n        privacy_version=consent.privacy_version,\n        accepted_at=consent.accepted_at\n    )\n\n\n@router.delete("/withdraw")\nasync def withdraw_consent(\n    current_user: User = Depends(get_current_user),\n    db: Session = Depends(get_db)\n):\n    """\n    Withdraw consent and trigger account deletion process.\n    \n    SRS: NFR6 - GDPR Right to be Forgotten\n    Sprint: 1.2 - Story 1.9\n    """\n    consent = db.query(UserConsent).filter(\n        UserConsent.user_id == current_user.id\n    ).first()\n    \n    if consent:\n        # Mark for deletion (14-day grace period)\n        consent.terms_accepted = False\n        consent.privacy_accepted = False\n        db.commit()\n    \n    logger.info(f"Consent withdrawn for user {current_user.id}")\n    \n    return {\n        "message": "Consent withdrawn. Account will be deleted within 14 days."\n    }
